# Refresh Token + Access Token Implementation

## Overview

This document describes the refresh token + access token authentication system implemented for the Template Java App. This system provides enhanced security with short-lived access tokens and long-lived refresh tokens stored as HttpOnly cookies for web clients and in app storage for mobile clients.

## System Architecture

### Token Types

1. **Access Token (JWT)**
   - **Lifetime**: 15 minutes (configurable via `app.jwt.expiration`)
   - **Storage**: Authorization header (`Bearer <token>`)
   - **Contents**: userId, userType, username, adminLevel (for admins)
   - **Purpose**: Used for API authorization on every request
   - **Validation**: Stateless JWT validation (no database lookup)

2. **Refresh Token**
   - **Lifetime**: 30 days (configurable via `app.jwt.refresh-expiration`)
   - **Storage**: 
     - Web: HttpOnly secure cookie (XSS-safe)
     - Mobile: Request body / app secure storage
   - **Format**: UUID (opaque token, not JWT)
   - **Purpose**: Used to obtain new access tokens
   - **Validation**: Database lookup required
   - **Security**: Token rotation on every use

### User Types

This system supports three user types:
- `client` - Clients/customers
- `coach` - Coaches/trainers
- `admin` - System administrators (with level-based access: 0, 1, 2)

---

## Database Schema

### RefreshToken Table

```sql
CREATE TABLE refresh_tokens (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    token VARCHAR(255) NOT NULL UNIQUE,
    user_id BIGINT NOT NULL,
    user_type VARCHAR(20) NOT NULL,
    expiry_date DATETIME NOT NULL,
    created_at DATETIME NOT NULL,
    last_used_at DATETIME,
    is_revoked BOOLEAN NOT NULL DEFAULT FALSE,
    device_info VARCHAR(500),
    ip_address VARCHAR(45),
    
    INDEX idx_refresh_token (token),
    INDEX idx_refresh_user_composite (user_id, user_type),
    INDEX idx_refresh_expiry_date (expiry_date),
    INDEX idx_refresh_is_revoked (is_revoked)
);
```

---

## Configuration

### application.properties

```properties
# JWT Configuration
app.jwt.secret=${JWT_SECRET:your-secret-key-here}
app.jwt.expiration=${JWT_EXPIRATION_MS:900000}           # 15 minutes
app.jwt.refresh-expiration=${JWT_REFRESH_EXPIRATION_MS:2592000000}  # 30 days
app.jwt.issuer=g4stly

# Refresh Token Cookie Configuration
app.refresh-token.cookie-name=${REFRESH_TOKEN_COOKIE_NAME:refreshToken}
app.refresh-token.cookie-max-age=${REFRESH_TOKEN_COOKIE_MAX_AGE:2592000}  # 30 days in seconds
app.refresh-token.use-cookies=${REFRESH_TOKEN_USE_COOKIES:true}
```

---

## API Endpoints

### 1. Login (Modified)

**Endpoint**: `POST /api/v1/auth/login`

**Request**:
```json
{
  "username": "testuser",
  "password": "password123",
  "userType": "client"
}
```

**Response** (Success - 200 OK):
```json
{
  "success": true,
  "message": "Login successful",
  "token": "eyJhbGciOiJIUzI1Ni...",
  "user": {
    "id": 1,
    "username": "testuser",
    "email": "test@example.com",
    "userType": "client"
  }
}
```

**Note**: For web clients, refresh token is automatically set as HttpOnly cookie. Mobile clients should extract refresh token from `Set-Cookie` header or use request body in refresh endpoint.

---

### 2. Refresh Token

**Endpoint**: `POST /api/v1/auth/refresh`

**Description**: Exchanges a valid refresh token for a new access token and refresh token.

**Request** (Mobile clients):
```json
{
  "refreshToken": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Request** (Web clients):
- Refresh token sent automatically via HttpOnly cookie
- Request body can be empty

**Response** (Success - 200 OK):
```json
{
  "accessToken": "eyJhbGciOiJIUzI1Ni...",
  "tokenType": "Bearer",
  "expiresIn": 900,
  "refreshToken": "660e8400-e29b-41d4-a716-446655440001"
}
```

**Note**:
- Old refresh token is automatically revoked (token rotation)
- New refresh token is set in HttpOnly cookie for web clients
- `refreshToken` field only included in response for mobile clients

**Error Responses**:

401 Unauthorized - Invalid/expired token:
```json
{
  "error": "Invalid or expired refresh token. Please login again."
}
```

---

### 3. Logout

**Endpoint**: `POST /api/v1/auth/logout`

**Description**: Revokes the current refresh token and clears cookies.

**Request** (Mobile clients):
```json
{
  "refreshToken": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Request** (Web clients):
- Refresh token sent automatically via HttpOnly cookie
- Request body can be empty

**Response** (Success - 200 OK):
```json
{
  "message": "Logged out successfully",
  "success": true
}
```

---

### 4. Logout from All Devices

**Endpoint**: `POST /api/v1/auth/logout-all`

**Description**: Revokes ALL refresh tokens for the authenticated user.

**Headers**:
```
Authorization: Bearer <access-token>
```

**Response** (Success - 200 OK):
```json
{
  "message": "Logged out from all devices successfully",
  "revokedTokens": 3,
  "success": true
}
```

---

## Admin Endpoints

All admin endpoints require `ROLE_ADMIN` and admin level 0 authorization.

### 1. Get All Refresh Tokens (with filters)

**Endpoint**: `GET /api/v1/admin/refresh-tokens`

**Query Parameters** (all optional):
- `userType`: Filter by user type (client, coach, admin)
- `userId`: Filter by specific user ID
- `isRevoked`: Filter by revocation status (true/false)
- `ipAddress`: Filter by IP address

**Example**: `GET /api/v1/admin/refresh-tokens?userType=client&isRevoked=false`

**Response** (Success - 200 OK):
```json
[
  {
    "id": 1,
    "tokenPreview": "550e8400...",
    "userId": 5,
    "userType": "client",
    "username": "testuser",
    "expiryDate": "2026-03-15T10:30:00",
    "createdAt": "2026-02-15T10:30:00",
    "lastUsedAt": "2026-02-16T15:45:00",
    "isRevoked": false,
    "isExpired": false,
    "deviceInfo": "Mozilla/5.0...",
    "ipAddress": "192.168.1.100"
  }
]
```

---

### 2. Get Refresh Token by ID

**Endpoint**: `GET /api/v1/admin/refresh-tokens/{id}`

**Response** (Success - 200 OK):
```json
{
  "id": 1,
  "tokenPreview": "550e8400...",
  "userId": 5,
  "userType": "client",
  "username": "testuser",
  "expiryDate": "2026-03-15T10:30:00",
  "createdAt": "2026-02-15T10:30:00",
  "lastUsedAt": "2026-02-16T15:45:00",
  "isRevoked": false,
  "isExpired": false,
  "deviceInfo": "Mozilla/5.0...",
  "ipAddress": "192.168.1.100"
}
```

---

### 3. Get Active Tokens for User

**Endpoint**: `GET /api/v1/admin/refresh-tokens/user/{userId}`

**Query Parameters**:
- `userType`: Required (client, coach, admin)

**Example**: `GET /api/v1/admin/refresh-tokens/user/5?userType=client`

**Response**: Array of active (non-revoked, non-expired) tokens for that user

---

### 4. Get Token Statistics

**Endpoint**: `GET /api/v1/admin/refresh-tokens/stats`

**Response** (Success - 200 OK):
```json
{
  "totalActiveTokens": 150,
  "totalTokens": 200,
  "activeTokensByUserType": {
    "client": 80,
    "coach": 45,
    "admin": 25
  },
  "clientTokens": 80,
  "coachTokens": 45,
  "adminTokens": 25
}
```

---

### 5. Revoke Token by ID

**Endpoint**: `PUT /api/v1/admin/refresh-tokens/{id}/revoke`

**Response** (Success - 200 OK):
```json
{
  "message": "Refresh token revoked successfully"
}
```

---

### 6. Revoke All User Tokens

**Endpoint**: `PUT /api/v1/admin/refresh-tokens/revoke-all`

**Query Parameters**:
- `userId`: Required (Long)
- `userType`: Required (client, coach, admin)

**Example**: `PUT /api/v1/admin/refresh-tokens/revoke-all?userId=5&userType=client`

**Response** (Success - 200 OK):
```json
{
  "message": "All tokens revoked for user",
  "revokedCount": 3
}
```

---

### 7. Delete Token by ID

**Endpoint**: `DELETE /api/v1/admin/refresh-tokens/{id}`

**Description**: Permanently removes token from database (use with caution).

**Response** (Success - 200 OK):
```json
{
  "message": "Refresh token deleted successfully"
}
```

---

### 8. Manual Cleanup

**Endpoint**: `POST /api/v1/admin/refresh-tokens/cleanup`

**Description**: Manually trigger cleanup of expired/revoked tokens (also runs daily at 2:00 AM automatically).

**Response** (Success - 200 OK):
```json
{
  "message": "Token cleanup completed",
  "tokensRemoved": 45
}
```

---

## Security Features

### 1. Token Rotation

Every time a refresh token is used, a new one is generated and the old one is revoked. This limits the window of vulnerability if a token is compromised.

### 2. Reuse Detection

If a revoked refresh token is used (indicating possible token theft), ALL tokens for that user are immediately revoked, forcing re-authentication on all devices.

### 3. HttpOnly Cookies (Web)

Refresh tokens are stored in HttpOnly cookies for web clients, making them inaccessible to JavaScript and protecting against XSS attacks.

### 4. Device Tracking

Each refresh token stores device information and IP address for audit and security purposes.

### 5. Automatic Cleanup

A scheduled task runs daily at 2:00 AM to remove expired and revoked tokens older than 7 days.

### 6. Expiry Management

- Access tokens expire after 15 minutes
- Refresh tokens expire after 30 days
- Tokens are checked for expiry on every use

---

## Scheduled Tasks

### Automatic Token Cleanup

**Schedule**: Daily at 2:00 AM (cron: `0 0 2 * * *`)

**What it does**:
1. Deletes tokens that are both revoked AND expired
2. Deletes tokens that expired more than 7 days ago

**Configuration**: Defined in `ScheduledTasks.java`

---

## Integration Guide

### For Web Applications

See [26.2REFRESH_TOKEN_FRONTEND_MIGRATION.md](26.2REFRESH_TOKEN_FRONTEND_MIGRATION.md) for detailed frontend integration instructions.

**Key Points**:
- Always include `credentials: 'include'` in fetch/axios requests
- Refresh token automatically sent via cookie
- Implement request interceptor for automatic token refresh on 401 errors

### For Mobile Applications

**Key Points**:
- Store refresh token securely (encrypted shared preferences / keychain)
- Include refresh token in request body for `/refresh` endpoint
- Handle 401 errors by calling refresh endpoint
- Clear tokens on logout

---

## Testing

### Manual Testing

1. **Login**: Call `/login` endpoint, verify you receive access token
2. **API Call**: Use access token in Authorization header
3. **Wait 15 minutes**: Let access token expire
4. **API Call Again**: Should get 401 Unauthorized
5. **Refresh**: Call `/refresh` endpoint with refresh token
6. **API Call**: Use new access token - should succeed
7. **Logout**: Call `/logout`, verify token is revoked
8. **Refresh Again**: Should fail with 401

### Admin Testing

1. Call `/admin/refresh-tokens/stats` - view token statistics
2. Call `/admin/refresh-tokens?userType=client` - view client tokens
3. Revoke a token and verify user gets logged out on next API call

---

## Troubleshooting

### Issue: "Invalid or expired refresh token"

**Causes**:
- Refresh token has expired (> 30 days old)
- Refresh token was revoked
- Token doesn't exist in database

**Solution**: User must login again

---

### Issue: Web client not receiving refresh token

**Check**:
1. CORS configuration allows credentials
2. Client includes `credentials: 'include'` in requests
3. Cookie domain matches frontend domain

---

### Issue: All tokens revoked unexpectedly

**Cause**: Reuse detection triggered - a revoked token was used

**Solution**: This is a security feature. User must login again.

---

## Migration from Old System

If migrating from a single-token system:

1. **Phase 1**: Deploy new backend (backward compatible)
   - Login still works the same way
   - Access token returned in both `token` and `accessToken` fields
   
2. **Phase 2**: Update frontend to use refresh tokens
   - Implement auto-refresh logic
   - Update storage to use cookies/secure storage

3. **Phase 3**: Remove `token` field support (breaking change)
   - Update all clients first!

---

## Best Practices

1. **Always use HTTPS** in production (set cookie `Secure` flag)
2. **Store tokens securely** on mobile (encrypted storage)
3. **Never log refresh tokens** in production
4. **Monitor token usage** via admin endpoints
5. **Set appropriate CORS policies** for your domains
6. **Use token rotation** to limit exposure
7. **Implement reuse detection** for security
8. **Clean up expired tokens** regularly (automated)

---

## Related Files

- Model: `models/RefreshToken.java`
- Repository: `repos/RefreshTokenRepository.java`
- Service: `services/RefreshTokenService.java`
- Controller: `controllers/RefreshTokenController.java`
- Admin Controller: `controllers/AdminRefreshTokenController.java`
- JWT Utilities: `security/JwtUtils.java`
- Scheduled Tasks: `config/ScheduledTasks.java`
- Documentation: `docs/26.1REFRESH_TOKEN_IMPLEMENTATION_PLAN.md`
- Frontend Guide: `docs/26.2REFRESH_TOKEN_FRONTEND_MIGRATION.md`

---

## Support

For questions or issues:
1. Check logs for detailed error messages
2. Verify configuration in `application.properties`
3. Use admin endpoints to inspect token state
4. Review security documentation for best practices
