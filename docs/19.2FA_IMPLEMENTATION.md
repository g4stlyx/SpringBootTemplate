# Two-Factor Authentication (2FA) Implementation

## Overview

Two-Factor Authentication (2FA) has been implemented for **Admin users only** using TOTP (Time-Based One-Time Password) compatible with Google Authenticator, Authy, and other authenticator apps.

## Why Admin-Only 2FA?

1. **Security Priority**: Admins have the highest privileges and access to sensitive data
2. **User Experience**: Clients/coaches already have email verification + CAPTCHA protection
3. **Flexibility**: Can be extended to other user types later if needed

## Features

- **TOTP Algorithm**: Standard 6-digit codes that change every 30 seconds
- **QR Code Generation**: Easily scan with any authenticator app
- **Manual Entry Key**: Fallback for apps that don't support QR scanning
- **Secure Enable/Disable**: Requires code verification to enable or disable

## API Endpoints

### 2FA Management (Authenticated Admin Required)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/admin/2fa/status` | Check if 2FA is enabled |
| POST | `/api/v1/admin/2fa/setup` | Generate QR code and secret |
| POST | `/api/v1/admin/2fa/verify` | Verify code and enable 2FA |
| POST | `/api/v1/admin/2fa/disable` | Disable 2FA (requires code) |

### 2FA Login (Public)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/v1/admin/2fa/verify-login` | Complete login with 2FA code |

## Setup Flow

```
1. Admin logs in normally → Gets JWT token
2. GET /api/v1/admin/2fa/status → Check if 2FA enabled (false)
3. POST /api/v1/admin/2fa/setup → Get QR code + secret
4. Scan QR code with authenticator app
5. POST /api/v1/admin/2fa/verify with 6-digit code
6. 2FA is now enabled!
```

## Login Flow (When 2FA Enabled)

```
1. POST /api/v1/auth/login with username/password
   → Password is verified first
   → Returns HTTP 202 with:
   {
     "requiresTwoFactor": true,
     "twoFactorChallengeToken": "a1b2c3d4...", // 64-char hex token
     "username": "admin",
     "message": "Two-factor authentication required..."
   }
   
   A challenge token is generated and stored with 5-minute expiration.

2. POST /api/v1/admin/2fa/verify-login with username + 6-digit code + challengeToken
   → Request body:
   {
     "username": "admin",
     "code": "123456",
     "challengeToken": "a1b2c3d4..."
   }
   
   → Challenge token is validated (must exist, match, not expired, <5 failed attempts)
   → 2FA code is verified
   → Returns HTTP 200 with:
   {
     "success": true,
     "accessToken": "eyJ...",
     "refreshToken": "...",
     "user": { ... }
   }
```

**Security Note:** The challenge token ensures that the user has successfully provided valid credentials (password) before being allowed to complete 2FA. Without this token, an attacker cannot bypass the password step and attempt 2FA brute-force with just a username and 6-digit code.

## Database Changes

The `Admin` model includes the following 2FA-related fields:
- `two_factor_enabled` (Boolean) - Whether 2FA is enabled
- `two_factor_secret` (String) - The TOTP secret key
- `two_factor_challenge_token` (String, 64 chars) - Short-lived token issued after password verification
- `two_factor_challenge_expires_at` (DateTime) - Challenge token expiration timestamp
- `two_factor_challenge_attempts` (Integer) - Failed verification attempts counter

## CAPTCHA Integration

CAPTCHA verification is available for admin logins:
- Enabled via `recaptcha.enabled=true` in application.properties
- Required when enabled, token passed via `captchaToken` field in login request
- Uses Google reCAPTCHA v2/v3

## Configuration

### application.properties

```properties
# Application Name (shown in authenticator app)
app.name=Further-Up

# ReCAPTCHA (for admin login)
recaptcha.site-key=${RECAPTCHA_SITE_KEY}
recaptcha.secret-key=${RECAPTCHA_SECRET_KEY}
recaptcha.enabled=${RECAPTCHA_ENABLED:false}
recaptcha.score-threshold=${RECAPTCHA_SCORE_THRESHOLD:0.5}
```

### .env (Example)

```
RECAPTCHA_SITE_KEY=your-site-key
RECAPTCHA_SECRET_KEY=your-secret-key
RECAPTCHA_ENABLED=true
```

## Dependencies

Already added to `pom.xml`:
- `com.warrenstrange:googleauth:1.5.0` - TOTP generation/verification
- `com.google.zxing:core:3.5.3` - QR code generation
- `com.google.zxing:javase:3.5.3` - QR code image rendering

## Security Considerations

1. **Secret Storage**: 2FA secrets are stored in the database (consider encryption at rest)
2. **Code Expiry**: TOTP codes expire every 30 seconds
6. **Challenge Token Protection**: 
   - Challenge tokens are required to complete 2FA login
   - Tokens are 64 characters (UUID-based) for high entropy
   - Tokens expire after 5 minutes
   - Tokens are invalidated after 3 failed 2FA attempts
   - Tokens are cleared after successful authentication
   - Prevents attackers from bypassing password verification
3. **Window Size**: 5 time steps tolerance for clock drift
4. **Disable Protection**: Disabling 2FA requires current valid code
5. **Login Attempts**: Account lockout after 5 failed attempts (applies to password phase)

## Testing

Use the Postman collection `0auth.postman_collection.json` which includes:
- **2. Two-Factor Auth Management** folder with all 2FA endpoints
- Test scripts for saving tokens automatically
- Detailed descriptions for each request

## Files Modified/Created

### New Files
- `src/main/java/com/furtherup/app/services/TwoFactorAuthService.java`
- `src/main/java/com/furtherup/app/controllers/TwoFactorAuthController.java`

### Modified Files
- `src/main/java/com/furtherup/app/controllers/AuthController.java` - Added CAPTCHA + 2FA redirect
- `src/main/java/com/furtherup/app/services/AuthService.java` - Added 2FA check in admin login
- `src/main/java/com/furtherup/app/dto/auth/AuthResponse.java` - Added `requiresTwoFactor` field
- `src/main/java/com/furtherup/app/dto/auth/LoginRequest.java` - Added `captchaToken` field
- `src/main/java/com/furtherup/app/config/SecurityConfig.java` - Added 2FA verify-login as public
- `postman_files/0auth.postman_collection.json` - Added 2FA endpoints folder

### Existing DTO Files (Previously Created)
- `src/main/java/com/furtherup/app/dto/two_factor/TwoFactorLoginRequest.java`
- `src/main/java/com/furtherup/app/dto/two_factor/TwoFactorRequiredResponse.java`
- `src/main/java/com/furtherup/app/dto/two_factor/TwoFactorSetupResponse.java`
- `src/main/java/com/furtherup/app/dto/two_factor/TwoFactorVerifyRequest.java`
